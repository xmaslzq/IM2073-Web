<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBook Store</title>
    <style>
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #444;
            padding: 10px 20px;
        }

        .user-name {
            color: white;
            font-size: 16px;
            margin-left: 30px;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }

        header {
            background-color: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
        }

        nav a {
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            text-align: center;
            font-size: 16px;
        }

            nav a:hover {
                background-color: #575757;
            }

        .cart {
            float: right;
            padding: 15px;
            background-color: #575757;
            color: white;
            border-radius: 5px;
        }

        .sign-out-btn {
            float: right;
            padding: 15px 30px;
            background-color: #FF4C4C;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 7px;
            margin-left: 20px;
            font-size: 16px;
        }

            .sign-out-btn:hover {
                background-color: #D13D3D;
            }

        .hero {
            background-image: url('https://via.placeholder.com/1500x500');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 80px 20px;
            text-align: center;
        }

            .hero h1 {
                font-size: 50px;
                margin: 0;
                color: #333;
            }

            .hero p {
                font-size: 20px;
                margin-top: 10px;
                color: #333;
            }

        .main-content {
            padding: 40px 20px;
            text-align: center;
        }

        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
            justify-items: center;
        }

        .book-item {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

            .book-item:hover {
                transform: translateY(-10px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            }

            .book-item img {
                width: 250px;
                height: 350px;
                object-fit: cover;
                border-radius: 8px;
            }

            .book-item h3 {
                margin: 15px 0;
                font-size: 18px;
                color: #333;
            }

            .book-item p {
                color: #777;
            }

            .book-item button {
                background-color: #333;
                color: white;
                padding: 10px;
                border: none;
                cursor: pointer;
                border-radius: 5px;
                transition: background-color 0.3s;
            }

                .book-item button:hover {
                    background-color: #555;
                }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Team2 Production eBook Store</h1>
    </header>

    <!-- Navigation Bar -->
    <nav>
        <a href="Home.html">Home</a>
        <a href="querybook.html">Books</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" class="cart">Cart: <span id="cart-count">0</span> items</a>
        <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
        <span class="user-name" id="username">Welcome, User</span>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <h1>Welcome to the eBook Store</h1>
        <p>Explore a world of knowledge, stories, and adventures at your fingertips!</p>
    </section>

    <!-- Main Content -->
    <div class="main-content">
        <h2>Featured Books</h2>
        <div class="book-list" id="book-list">
            <!-- Featured books will be dynamically loaded here -->
        </div>
    </div>

    <footer>
        <p>&copy; 2025 eBook Store | All rights reserved.</p>
    </footer>

    <script>
        // Fetch cart count for the user
        async function fetchCartCount() {
            const user = JSON.parse(localStorage.getItem("user"));  // Retrieve user object
            const userId = user?.userId;  // Get userId from the user object
            if (!userId) {
                document.getElementById("cart-count").textContent = 0;  // No userId, no cart count
                return;
            }

            try {
                const response = await fetch(`http://localhost:9999/ebookshop/getCart?userId=${userId}`);
                const data = await response.json();

                // Update the cart count display
                if (data.cart && Array.isArray(data.cart)) {
                    document.getElementById("cart-count").textContent = data.cart.length || 0;
                } else {
                    document.getElementById("cart-count").textContent = 0;
                }
            } catch (error) {
                console.error("Error fetching cart count:", error);
                document.getElementById("cart-count").textContent = 0;
            }
        }


        // Fetch featured books
        async function fetchFeaturedBooks() {
            try {
                const response = await fetch("http://localhost:9999/ebookshop/api/books");
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const books = await response.json();
                displayFeaturedBooks(books.slice(0, 4));
            } catch (error) {
                console.error("Error fetching books:", error);
                document.getElementById("book-list").innerHTML = "<p>Error loading books. Please try again later.</p>";
            }
        }

        // Display featured books
        function displayFeaturedBooks(books) {
            const bookList = document.getElementById("book-list");
            bookList.innerHTML = "";

            books.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book-item";

                const safeTitle = book.title.replace(/"/g, "&quot;");

                bookDiv.innerHTML = `
                        <img src="${book.image_url || 'https://via.placeholder.com/250x350'}" alt="${safeTitle}" onerror="this.src='https://via.placeholder.com/250x350'">
                        <h3>${book.title}</h3>
                        <p>By ${book.author_name}</p>
                        <p><strong>$${parseFloat(book.price).toFixed(2)}</strong></p>
                        <button onclick="addToCart(${book.bookId})">Add to Cart</button>
                    `;
                bookList.appendChild(bookDiv);
            });
        }

        // Add book to cart
        async function addToCart(bookId) {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || !user.userId) {
                alert("Please log in to add items to your cart.");
                return;
            }

            const userId = user.userId; // Retrieve userId from localStorage
            await fetch("http://localhost:9999/ebookshop/addToCart", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `userId=${userId}&bookId=${bookId}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.success);
                        fetchCartCount();  // Refresh cart count
                    } else {
                        alert(data.error || "Failed to add to cart.");
                    }
                })
                .catch(error => {
                    console.error("Error adding to cart:", error);
                    alert("An error occurred while adding to the cart.");
                });
        }


        // Handle sign out button
        document.getElementById("signOutBtn").addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "login.html";
        });

        // Check if the 'username' is present in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        const userId = urlParams.get('userId'); // Assuming you also pass userId in the URL

        // If the username exists in the URL, store it in localStorage
        if (username && userId) {
            const user = { name: username, userId: userId }; // Create a user object
            localStorage.setItem("user", JSON.stringify(user)); // Store the user object
            localStorage.setItem("userId", userId);
        }

        // Update the UI
        async function displayUsername() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (user?.name) {
                document.getElementById("username").textContent = `Welcome, ${user.name}`;
            }
            if (user?.userId) {
                console.log("User ID: ", user.userId);  // You can also display the userId somewhere if needed
            }
        }

        window.onload = function () {
            fetchCartCount();
            fetchFeaturedBooks();
            displayUsername();  // Call to display the username
        };
    </script>
</body>
</html>
