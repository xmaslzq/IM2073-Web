<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - eBook Store</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 0;
            text-align: center;
        }
        nav {
            display: flex;
            justify-content: center;
            background-color: #444;
        }
        nav a {
            color: white;
            padding: 15px;
            text-decoration: none;
            text-align: center;
        }
        nav a:hover {
            background-color: #575757;
        }
        main {
            padding: 20px;
        }
        .cart-item {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-item input[type="number"] {
            width: 50px;
            padding: 5px;
            text-align: center;
        }
        .checkout-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        .checkout-button:hover {
            background-color: #27ae60;
        }
        .remove-button {
            background-color: #ff4c4c;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .remove-button:hover {
            background-color: #d13d3d;
        }
        .total-price {
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <header>
        <h1>eBook Store - Your Cart</h1>
    </header>

    <nav>
        <a href="Home.html">Home</a>
        <a href="querybook.html">Books</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" class="cart">Cart: <span id="cart-count">0</span> items</a>
    </nav>

    <main>
        <h2>Your Cart</h2>
        <div id="cart-items"></div>
        <h3 class="total-price">Total: $<span id="total-price">0.00</span></h3>

        <button class="checkout-button" onclick="checkout()">Checkout</button>
    </main>

    <script>
        async function fetchCart() {
            const userId = localStorage.getItem("userId"); // Retrieve user ID
            const response = await fetch(`http://localhost:9999/ebookshop/cart.html/getCart?userId=${userId}`);
            const data = await response.json();
            
            if (data.error) {
                document.getElementById("cart-items").innerHTML = `<p>${data.error}</p>`;
                return;
            }

            let cartItemsHtml = "";
            let totalPrice = 0;

            data.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalPrice += itemTotal;
                cartItemsHtml += `
                    <div class="cart-item">
                        <div>
                            <h3>${item.title}</h3>
                            <p>Price: $${item.price.toFixed(2)}</p>
                            <p>
                                Quantity: 
                                <button onclick="updateQuantity(${item.bookId}, ${item.quantity - 1})">-</button>
                                <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${item.bookId}, this.value)">
                                <button onclick="updateQuantity(${item.bookId}, ${item.quantity + 1})">+</button>
                            </p>
                        </div>
                        <button class="remove-button" onclick="removeFromCart(${item.bookId})">Remove</button>
                    </div>`;
            });

            document.getElementById("cart-items").innerHTML = cartItemsHtml;
            document.getElementById("total-price").textContent = totalPrice.toFixed(2);
        }

        async function updateQuantity(bookId, newQuantity) {
            if (newQuantity < 1) {
                removeFromCart(bookId);
                return;
            }

            const userId = localStorage.getItem("userId");

            await fetch(`http://localhost:9999/ebookshop/cart.html/updateCart`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `userId=${userId}&bookId=${bookId}&quantity=${newQuantity}`
            });

            fetchCart(); // Refresh the cart
        }

        async function removeFromCart(bookId) {
            const userId = localStorage.getItem("userId");

            await fetch(`http://localhost:9999/ebookshop/cart.html/removeCartItem`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `userId=${userId}&bookId=${bookId}`
            });

            fetchCart(); // Refresh the cart
        }

        async function checkout() {
            const userId = localStorage.getItem("userId");
            
            if (!userId) {
                alert("Please log in to proceed to checkout.");
                return;
            }

            const response = await fetch(`http://localhost:9999/ebookshop/checkout?userId=${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            });

            const data = await response.json();

            if (data.success) {
                alert("Checkout successful! Your order has been placed.");
                fetchCart(); // Refresh cart after checkout
            } else {
                alert("Error: " + data.error);
            }
        }

        window.onload = fetchCart;
    </script>

</body>
</html>
